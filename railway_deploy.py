#!/usr/bin/env python
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è SelexiaTravel –Ω–∞ Railway
"""

import os
import sys
import django
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É –≤ sys.path
BASE_DIR = Path(__file__).resolve().parent
sys.path.append(str(BASE_DIR))

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Django –¥–ª—è Railway
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'selexia_travel.settings')
os.environ.setdefault('RAILWAY_ENVIRONMENT', 'True')
django.setup()

from django.core.management import call_command
from django.conf import settings

def check_railway_environment():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Railway"""
    print("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Railway –æ–∫—Ä—É–∂–µ–Ω–∏—è...")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    env_vars = {
        'DATABASE_NAME': os.environ.get('DATABASE_NAME'),
        'DATABASE_USER': os.environ.get('DATABASE_USER'),
        'DATABASE_PASSWORD': os.environ.get('DATABASE_PASSWORD'),
        'DATABASE_HOST': os.environ.get('DATABASE_HOST'),
        'DATABASE_PORT': os.environ.get('DATABASE_PORT'),
        'DATABASE_ENGINE': os.environ.get('DATABASE_ENGINE'),
        'SECRET_KEY': os.environ.get('SECRET_KEY'),
    }
    
    print("üìä –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:")
    for key, value in env_vars.items():
        if value:
            if 'PASSWORD' in key or 'SECRET' in key:
                print(f"   ‚úÖ {key}: {'*' * len(value)}")
            else:
                print(f"   ‚úÖ {key}: {value}")
        else:
            print(f"   ‚ùå {key}: –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")
    
    return all(env_vars.values())

def run_migrations():
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    print("\nüóÑÔ∏è –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π...")
    
    try:
        call_command('migrate', verbosity=2)
        print("‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!")
        return True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π: {e}")
        return False

def collect_static():
    """–°–æ–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã"""
    print("\nüì¶ –°–±–æ—Ä —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤...")
    
    try:
        call_command('collectstatic', '--noinput', verbosity=2)
        print("‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã —Å–æ–±—Ä–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ!")
        return True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∞ —Å—Ç–∞—Ç–∏–∫–∏: {e}")
        return False

def create_superuser():
    """–°–æ–∑–¥–∞–µ—Ç —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç"""
    print("\nüë§ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...")
    
    try:
        from django.contrib.auth import get_user_model
        User = get_user_model()
        
        if User.objects.filter(is_superuser=True).exists():
            print("‚úÖ –°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!")
            return True
        
        # –°–æ–∑–¥–∞–µ–º —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        call_command('createsuperuser', 
                    username='admin',
                    email='admin@railway.app',
                    interactive=False)
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–æ–ª—å
        user = User.objects.get(username='admin')
        user.set_password('admin123')
        user.save()
        
        print("‚úÖ –°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω!")
        print("   üëë –õ–æ–≥–∏–Ω: admin")
        print("   üîë –ü–∞—Ä–æ–ª—å: admin123")
        print("   üìß Email: admin@railway.app")
        
        return True
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        return False

def check_database():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"""
    print("\nüîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
    
    try:
        from django.db import connection
        cursor = connection.cursor()
        cursor.execute("SELECT version();")
        version = cursor.fetchone()
        print(f"‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å–ø–µ—à–Ω–æ!")
        print(f"   üóÑÔ∏è –í–µ—Ä—Å–∏—è: {version[0] if version else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        from django.contrib.auth import get_user_model
        User = get_user_model()
        user_count = User.objects.count()
        print(f"   üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {user_count}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î: {e}")
        return False

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    print("üöÇ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ SelexiaTravel –Ω–∞ Railway...")
    print("=" * 60)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º Railway –æ–∫—Ä—É–∂–µ–Ω–∏–µ
    if not check_railway_environment():
        print("\n‚ùå –ù–µ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Railway —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!")
        print("üìã –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤ Railway —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:")
        print("   - DATABASE_NAME, DATABASE_USER, DATABASE_PASSWORD")
        print("   - DATABASE_HOST, DATABASE_PORT")
        print("   - SECRET_KEY")
        print("   - DATABASE_ENGINE=railway")
        return False
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    if not check_database():
        print("\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö!")
        return False
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
    if not run_migrations():
        print("\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏!")
        return False
    
    # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
    if not collect_static():
        print("\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã!")
        return False
    
    # –°–æ–∑–¥–∞–µ–º —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if not create_superuser():
        print("\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!")
        return False
    
    print("\n" + "=" * 60)
    print("üéâ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ Railway –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!")
    print("\nüìã –î–æ—Å—Ç—É–ø–Ω—ã–µ URL:")
    print("   üåê –°–∞–π—Ç: https://your-app.up.railway.app")
    print("   üë§ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: https://your-app.up.railway.app/admin/")
    print("   üîë –õ–æ–≥–∏–Ω: admin")
    print("   üîê –ü–∞—Ä–æ–ª—å: admin123")
    
    return True

if __name__ == '__main__':
    main()
